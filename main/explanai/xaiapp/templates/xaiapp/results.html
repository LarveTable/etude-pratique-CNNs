{% extends "xaiapp/base.html"%} {%block title %} Results {% endblock %}
{%block content %}

<!-- TODO 
- Use the same form as before but disabled
-->

<div class="container mt-3">
  <h1>Results</h1>
  <div class="p-2 container border rounded mb-3">
    <div class="flex row">
      <div class="col">
        <h4>Experiment nÂ°{{experiment_id}} 
          <span id="status_badge" class="badge text-bg-warning">{{experiment_status}}</span>
        </h4>
        <p>
          Model: {{config_data.model_name}} <br>
          Methods tested: <br>
        <ul>{% for mth_name in methods%} <li>{{mth_name}}</li>{%endfor%}</ul>
        </p>
      </div>
      <!-- <div class="vr"></div> -->
      <div class="col">
        <h3>Informations</h3>
        <p>
          <h5>Global</h5>
          Total time: <span id="total-time">0s</span> <br>
          Mean time: <span id="mean-time">0s</span> <br>
          Max Time: <span id="max-time">0s</span> 
          Min Time: <span id="min-time">0s</span>
          {% for mth_name in methods%}
            <h5>{{mth_name}}</h5>
            Total: <span id="{{mth_name}}-total-time">0s</span><br>
            Mean: <span id="{{mth_name}}-mean-time">0s</span><br>
            Max: <span id="{{mth_name}}-max-time">0s</span><br>
            Min: <span id="{{mth_name}}-min-time">0s</span><br>
            Var: <span id="{{mth_name}}-var-time">0s</span><br>
          {%endfor%}
        </p>
      </div>
    </div>
  </div>
</div>

<div class="container mb-6">
  <div class="row row-cols-auto g-2">
    {%if in_images%}
    {% for img in in_images%}
    <div class="col-auto h-100">
      <!-- <a id="link-{{img.image}}" href="/result/{{experiment_id}}/{{img.id}}"> -->
      <a id="link-{{img.image}}" href="">
        <div id="{{img.image}}" class="card border-warning border-3" style="width: 100px;">
          <img src="{{img.image.url}}" class="card-img-top" style="width: 100%; height:100px; object-fit:cover;"
            alt="{{img.image.url}}" title="{{img.image.url}}">
          <div class="card-body pt-0 pb-0">
            <!--<h5 class="card-title" style="overflow: scroll;
          max-width: 100%;
          text-overflow: ellipsis;
          width: fit-content;
          white-space: nowrap;">{{img.image}}</h5>-->
            <p class="card-text"><small id="time-{{img.image}}" class="text-muted">0s</small></p>
          </div>
        </div>
      </a>
    </div>
    {%endfor%}
    {%else%}
    <p>
      no input images
    </p>
    {%endif%}
  </div>
</div>

<script>
  // SSE
  const eventSource = new EventSource("/experiment_update/" + "{{experiment_id}}/");

  console.log("ready for updates on Expe:" + "{{experiment_id}}" + "{{experiment_status}}");
  // When a message is received 
  eventSource.onmessage = function (e) {
    const data = JSON.parse(e.data);
    console.log(data);

    // Update UI status for every cards 
    // each img status :
    // find by Id 
    // Change border according to status
    const imagesStatus = data.status;
    imagesStatus.forEach(imgS => {
      const imgCard = document.getElementById(imgS.imgName)
      const imgStatus = imgS.status;
      switch (imgStatus) {
        case "finished":
          // Change border to green
          updateClass(imgS.imgName, "border-warning", "border-success");
          // Add link to image 
          let imgLink = document.getElementById("link-"+imgS.imgName);
          // Check if the element exists
          if (imgLink) {
              // Modify the href attribute
              imgLink.href = '/result/{{experiment_id}}/' + imgS.id + '/';
          }
          // Time 
          let imgTime = document.getElementById("time-"+imgS.imgName);
          if (imgTime) {
              // Modify the href attribute
              imgTime.innerHTML = imgS.img_time + "s";
          }

          break;
      }
      //const times = data.times;

    });
    // Stats
    // Total mean time
    let meanTime, maxTime, medianTime, varianceTime, totalTime;
    totalTime = data.statistics.total_time;
    let totalTimeElt = document.getElementById("total-time");
    totalTimeElt.innerHTML = totalTime + "s";
    // Global mean time
    meanTime = data.statistics.mean_time;
    let meanTimeElt = document.getElementById("mean-time");
    meanTimeElt.innerHTML = meanTime + "s";
    // max time
    maxTime = data.statistics.max_time;
    let maxTimeElt = document.getElementById("max-time");
    maxTimeElt.innerHTML = maxTime + "s";
    // min time
    minTime = data.statistics.min_time;
    let minTimeElt = document.getElementById("min-time");
    minTimeElt.innerHTML = minTime + "s";

    // For each method
    data.methods.forEach(m => {
      let methodStats = data.statistics;
      let meanTime, maxTime, medianTime, varianceTime, totalTime;
      
      // total time
      totalTime = methodStats.total_time;
      let totalTimeElt = document.getElementById(m+"-total-time");
      totalTimeElt.innerHTML = totalTime + "s";

      // mean time
      meanTime = methodStats.mean_time;
      let meanTimeElt = document.getElementById(m+"-mean-time");
      meanTimeElt.innerHTML = meanTime + "s";

      // max time
      maxTime = methodStats.max_time;
      let maxTimeElt = document.getElementById(m+"-max-time");
      maxTimeElt.innerHTML = maxTime + "s";

      // min time
      minTime = methodStats.min_time;
      let minTimeElt = document.getElementById(m+"-min-time");
      minTimeElt.innerHTML = minTime + "s";
    })

    // If the experiment is done : close the updates
    if ("{{experiment_status}}" == "finished") {
      updateClass("status_badge", "text-bg-warning", "text-bg-success");
      eventSource.close();
    }
  };


  eventSource.onerror = function (e) {
    console.error('EventSource failed:', e);
  };

  function updateClass(id, oldClass, newClass) {
    const e = document.getElementById(id);

    e.classList.remove(oldClass);
    e.classList.add(newClass);
  }

</script>


{% endblock %}